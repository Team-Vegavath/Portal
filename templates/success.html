{% extends "layout.html" %}
{% block content %}
<div class="card mx-auto shadow p-4" style="max-width:700px;">
    <h3 class="text-center text-primary mb-3">â³ Upload Progress</h3>

    <!-- Progress bar -->
    <div class="progress mb-3" style="height:25px;">
        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
             role="progressbar" style="width: 0%;">0%</div>
    </div>

    <!-- Log output -->
    <div class="border rounded p-3 bg-light" style="height: 280px; overflow-y: auto; font-family: monospace;">
        <div id="log">Connecting to server...</div>
    </div>

    <!-- Back button -->
    <div class="text-center mt-4">
        <a href="/" id="backBtn" class="btn btn-primary" style="display:none;">â¬…ï¸ Back to Verify</a>
    </div>
</div>

<script>
const uploadId = "{{ upload_id }}";
const eventSource = new EventSource(`/events/${uploadId}`);

let totalFiles = 0;
let uploaded = 0;
const bar = document.getElementById('progressBar');
const logDiv = document.getElementById('log');
const backBtn = document.getElementById('backBtn');

function log(msg, color="black") {
    const p = document.createElement('div');
    p.style.color = color;
    p.textContent = msg;
    logDiv.appendChild(p);
    logDiv.scrollTop = logDiv.scrollHeight;
}

// ---- Event Listeners ----

// Info event â€” total files
eventSource.addEventListener('info', e => {
    const data = e.data.replace(/"/g, "");
    log("â„¹ï¸ " + data, "blue");
    const match = data.match(/(\d+)/);
    if (match) totalFiles = parseInt(match[1]);
});

// Successful upload per file
eventSource.addEventListener('upload_done', e => {
    const d = JSON.parse(e.data);
    uploaded = d.index;
    const percent = totalFiles ? Math.round((uploaded / totalFiles) * 100) : 0;
    bar.style.width = percent + "%";
    bar.textContent = percent + "%";
    log(`âœ… Uploaded: ${d.file} (${uploaded}/${totalFiles})`, "green");
});

// GitHub log (extra details)
eventSource.addEventListener('github_log', e => {
    const d = JSON.parse(e.data);
    const url = d.url ? d.url : "(no link)";
    log(`ğŸ“˜ GitHub API â†’ ${d.status} | ${d.file} | ${url}`, "#555");
});

// Error during upload
eventSource.addEventListener('upload_error', e => {
    const d = JSON.parse(e.data);
    log(`âŒ Error uploading ${d.file} (HTTP ${d.status})`, "red");
});

// Finished
eventSource.addEventListener('finished', e => {
    const msg = e.data.replace(/"/g, "");
    log(`ğŸ‰ ${msg}`, "green");
    bar.style.width = "100%";
    bar.textContent = "100%";
    setTimeout(() => {
        backBtn.style.display = "inline-block";
    }, 800);
});

// Any exceptions
eventSource.addEventListener('error', e => {
    log(`âš ï¸ Error: ${e.data}`, "red");
});

eventSource.addEventListener('closed', e => {
    eventSource.close();
    log("ğŸ”’ Connection closed.", "gray");
});
</script>
{% endblock %}
